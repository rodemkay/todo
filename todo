#!/bin/bash

# Neues zuverl√§ssiges Todo CLI Tool
# Version 2.0 - Mit robustem Error-Handling

# Farben
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Pfade
TODO_DIR="/home/rodemkay/www/react/plugin-todo"
HOOK_DIR="$TODO_DIR/hooks"
MANAGER="$HOOK_DIR/todo_manager.py"
MONITOR="$HOOK_DIR/monitor.py"
TESTER="$HOOK_DIR/test-suite.py"
COMPLETION_MONITOR="$HOOK_DIR/completion_monitor.py"
EMERGENCY_HANDLER="$HOOK_DIR/emergency_handlers.py"

# Session-Switching Pfade
SESSION_SWITCHER="$TODO_DIR/claude-switch.sh"
PROJECT_DETECTOR="$TODO_DIR/project-detector.sh"
SESSION_MANAGER="$TODO_DIR/session-manager.sh"
TMUX_CONTROLLER="$TODO_DIR/tmux-controller-v2.sh"  # Neue Version ohne Health-Check

# Pr√ºfe Python3
if ! command -v python3 &> /dev/null; then
    echo -e "${RED}Error: Python3 is required but not installed${NC}"
    exit 1
fi

# Pr√ºfe ob Manager existiert
if [ ! -f "$MANAGER" ]; then
    echo -e "${RED}Error: Todo manager not found at $MANAGER${NC}"
    exit 1
fi

# Session-Switching Funktionen
check_project_session() {
    # Nur pr√ºfen wenn Session-Switcher verf√ºgbar ist
    if [[ ! -f "$SESSION_SWITCHER" || ! -f "$PROJECT_DETECTOR" ]]; then
        return 0  # Kein Session-Switching verf√ºgbar, normal weitermachen
    fi
    
    # Aktuelles Projekt erkennen
    local current_project
    if ! current_project=$("$PROJECT_DETECTOR" current 2>/dev/null); then
        # Kein Projekt erkannt, Session-Switching √ºberspringen
        return 0
    fi
    
    # Pr√ºfen ob Session-Mismatch vorliegt
    local current_session
    if current_session=$("$SESSION_SWITCHER" status | grep "Aktuelle Session" | cut -d: -f2 | xargs 2>/dev/null); then
        # Wenn Session nicht zum Projekt passt, warnen aber nicht blockieren
        if [[ "$current_session" != "$current_project" ]]; then
            echo -e "${YELLOW}‚ö† Session-Mismatch erkannt:${NC}"
            echo -e "   Aktuelle Session: ${CYAN}$current_session${NC}"
            echo -e "   Projekt-Kontext: ${CYAN}$current_project${NC}"
            echo -e "${BLUE}üí° Tipp: Verwenden Sie './claude-switch.sh switch $current_project' f√ºr optimale Erfahrung${NC}"
            echo
        fi
    fi
    
    return 0
}

# Funktion f√ºr Hilfe
show_help() {
    echo -e "${BLUE}üìã TODO CLI - Robustes Hook System v2.0${NC}"
    echo ""
    echo "Verwendung:"
    echo -e "  ${GREEN}./todo${NC}              # L√§dt n√§chstes Todo (Loop-Modus)"
    echo -e "  ${GREEN}./todo -id <ID>${NC}     # L√§dt spezifisches Todo (Einzel-Modus)"
    echo -e "  ${GREEN}./todo complete${NC}     # Schlie√üt aktuelles Todo ab"
    echo -e "  ${GREEN}./todo status${NC}       # Zeigt aktuellen Status"
    echo -e "  ${GREEN}./todo monitor${NC}      # System Health Check"
    echo -e "  ${GREEN}./todo test${NC}         # F√ºhrt Tests aus"
    echo -e "  ${GREEN}./todo fix${NC}          # Behebt h√§ufige Probleme"
    echo -e "  ${GREEN}./todo health${NC}       # Health Check des Completion-Systems"
    echo -e "  ${GREEN}./todo emergency <id>${NC} # Emergency Completion f√ºr Todo"
    echo -e "  ${GREEN}./todo daemon${NC}       # Startet Monitor-Daemon"
    echo -e "  ${GREEN}./todo switch <projekt>${NC} # Wechselt zu anderem Projekt"
    echo -e "  ${GREEN}./todo session${NC}      # Zeigt Session-Status"
    echo -e "  ${GREEN}./todo help${NC}         # Zeigt diese Hilfe"
    echo ""
    echo "Verhalten:"
    echo "  ‚Ä¢ ./todo l√§dt alle Todos mit status='offen' und bearbeiten=1 nacheinander"
    echo "  ‚Ä¢ ./todo -id l√§dt ein spezifisches Todo und beendet danach"
    echo "  ‚Ä¢ Bei Abschluss werden HTML, Text und Summary automatisch generiert"
    echo "  ‚Ä¢ Claude's Outputs werden automatisch erfasst und gespeichert"
    echo "  ‚Ä¢ Session-Switching warnt bei Projekt-Mismatch und bietet Wechsel an"
}

# Hauptlogik
case "$1" in
    "")
        # Kein Parameter - lade n√§chstes Todo (Loop-Modus)
        check_project_session  # Session-Check vor Todo-Load
        echo -e "${BLUE}Loading next todo...${NC}"
        python3 "$MANAGER" load
        ;;
    
    "-id")
        # Spezifisches Todo laden
        if [ -z "$2" ]; then
            echo -e "${RED}Error: Todo ID required${NC}"
            echo "Usage: ./todo -id <ID>"
            exit 1
        fi
        check_project_session  # Session-Check vor Todo-Load
        echo -e "${BLUE}Loading todo #$2...${NC}"
        python3 "$MANAGER" load-id "$2"
        ;;
    
    "complete")
        # Todo abschlie√üen
        echo -e "${GREEN}Completing current todo...${NC}"
        python3 "$MANAGER" complete
        ;;
    
    "status")
        # Status anzeigen
        python3 "$MANAGER" status
        ;;
    
    "monitor")
        # System Health Check
        echo -e "${PURPLE}Running system health check...${NC}"
        python3 "$MONITOR" check
        ;;
    
    "test")
        # Tests ausf√ºhren
        echo -e "${PURPLE}Running test suite...${NC}"
        python3 "$TESTER"
        ;;
    
    "fix")
        # Probleme beheben
        echo -e "${YELLOW}Attempting to fix common issues...${NC}"
        python3 "$MONITOR" fix
        ;;
    
    "health")
        # Health Check des Completion-Systems
        echo -e "${BLUE}Running completion system health check...${NC}"
        python3 "$COMPLETION_MONITOR"
        ;;
    
    "emergency")
        # Emergency Completion f√ºr spezifische Todo-ID
        if [ -z "$2" ]; then
            echo -e "${RED}Error: Todo ID required for emergency completion${NC}"
            echo -e "${YELLOW}Usage: ./todo emergency <todo_id>${NC}"
            exit 1
        fi
        echo -e "${RED}üö® Running emergency completion for Todo #$2...${NC}"
        python3 "$EMERGENCY_HANDLER" emergency-complete "$2"
        ;;
    
    "daemon")
        # Startet Completion Monitor im Daemon-Modus
        echo -e "${BLUE}Starting completion monitor daemon...${NC}"
        echo -e "${YELLOW}Press Ctrl+C to stop${NC}"
        python3 "$COMPLETION_MONITOR" --daemon
        ;;
    
    "switch")
        # Session wechseln
        if [[ ! -f "$SESSION_SWITCHER" ]]; then
            echo -e "${RED}Error: Session-Switcher nicht verf√ºgbar${NC}"
            echo -e "${YELLOW}Session-Switching System ist nicht installiert${NC}"
            exit 1
        fi
        
        if [ -z "$2" ]; then
            echo -e "${RED}Error: Projekt-Name erforderlich${NC}"
            echo "Usage: ./todo switch <projekt>"
            echo
            echo -e "${BLUE}Verf√ºgbare Projekte:${NC}"
            "$SESSION_SWITCHER" list
            exit 1
        fi
        
        # TASK_COMPLETED sicherstellen
        if [[ ! -f "/tmp/TASK_COMPLETED" ]]; then
            echo -e "${YELLOW}‚ö† Setze TASK_COMPLETED vor Session-Wechsel${NC}"
            echo 'TASK_COMPLETED' > /tmp/TASK_COMPLETED
        fi
        
        "$SESSION_SWITCHER" switch "$2"
        ;;
    
    "session")
        # Session-Status anzeigen
        if [[ ! -f "$SESSION_SWITCHER" ]]; then
            echo -e "${YELLOW}Session-Switching System nicht verf√ºgbar${NC}"
            exit 0
        fi
        "$SESSION_SWITCHER" status
        ;;
    
    "help"|"-h"|"--help")
        show_help
        ;;
    
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        show_help
        exit 1
        ;;
esac